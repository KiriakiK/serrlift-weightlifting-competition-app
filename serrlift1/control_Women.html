<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <title>Î§ÏÎ¿Î½ÏŒÎ¼ÎµÏ„ÏÎ¿ Î†ÏÏƒÎ·Ï‚ Î’Î±ÏÏÎ½ - Control</title>
  <style>
    body {
      background: black;
      color: white;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    #timer {
      font-size: 8em;
      margin: 0.2em 0;
      transition: color 0.3s;
    }
    #timer.red {
      color: red;
    }
    select, input, button {
      font-size: 1.3em;
      margin: 0.3em;
      padding: 0.4em 0.8em;
    }
    label {
      display: inline-block;
      margin: 0.4em 1em;
      min-width: 160px;
      text-align: left;
    }
    #barbell {
      margin: 1em auto;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 60px;
      max-width: 600px;
    }
    .plate {
      width: 15px;
      border-radius: 4px;
      margin: 0 0px !important;
      box-shadow: inset 0 0 3px 0px #fff;
      border: 0 !important;
    }
    #attemptCircles {
      margin: 0.7em auto;
      display: flex;
      gap: 15px;
      justify-content: center;
      align-items: center;
      max-width: 200px;
    }
    .circle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid white;
      background-color: transparent;
      cursor: default;
    }
    .circle.valid {
      background-color: white;
    }
    .circle.invalid {
      background-color: red;
    }
    #attemptInfo {
      font-size: 1.3em;
      margin-top: 0.5em;
      min-height: 2em;
    }
    #controls {
      margin-top: 1em;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #fileInputLabel {
      display: inline-block;
      margin: 1em auto;
      padding: 0.4em 0.8em;
      background: #444;
      border-radius: 6px;
      cursor: pointer;
    }
    #fileInput {
      display: none;
    }
  </style>
</head>
<body>

  <h1>Î§ÏÎ¿Î½ÏŒÎ¼ÎµÏ„ÏÎ¿ Î†ÏÏƒÎ·Ï‚ Î’Î±ÏÏÎ½ - Control</h1>

  <!-- Î¦ÏŒÏÏ„Ï‰ÏƒÎ· JSON -->
  <label id="fileInputLabel" for="fileInput">Î¦ÏŒÏÏ„Ï‰ÏƒÎµ JSON Î‘Î¸Î»Î·Ï„ÏÎ¹ÏÎ½</label>
  <input type="file" id="fileInput" accept=".json" />
  <div>

    <label>Î†ÏƒÎºÎ·ÏƒÎ·:
      <select id="exerciseSelect" disabled>
        <option value="Î‘ÏÎ±ÏƒÎ­">Î‘ÏÎ±ÏƒÎ­</option>
        <option value="Î•Ï€Î¿Î»Î­-Î–ÎµÏ„Î­">Î•Ï€Î¿Î»Î­-Î–ÎµÏ„Î­</option>
      </select>
    </label>

    <label>Î‘Î¸Î»Î®Ï„ÏÎ¹Î±:
      <select id="athleteSelect" disabled>
        <option value="">-- Î•Ï€Î¹Î»Î¿Î³Î® --</option>
      </select>
    </label>

    <label>ÎšÎ¹Î»Î¬:
      <input type="number" id="weightInput" min="1" step="1" disabled />
    </label>
  </div>
  <div id="athleteInfo"></div>

  <div id="attemptInfo"></div>

  <div id="barbell"></div>

  <div id="attemptCircles"></div>

  <div id="timer">00:00</div>

  <div id="controls">
    <button id="btn1min" disabled>1 Î›Î•Î Î¤ÎŸ</button>
    <button id="btn2min" disabled>2 Î›Î•Î Î¤Î‘</button>
    <button id="btn5min" disabled>5 Î›Î•Î Î¤Î‘</button>
    <button id="btnPause" disabled>â¸ï¸ Î Î‘Î¥Î£Î— / Î£Î¥ÎÎ•Î§Î•Î™Î‘</button>
    <button id="btnReset" disabled>ğŸ›‘ RESET</button>
    <button id="btnValid" disabled>âœ… ÎˆÎ³ÎºÏ…ÏÎ· Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î±</button>
    <button id="btnInvalid" disabled>âŒ Î†ÎºÏ…ÏÎ· Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î±</button>
  </div>

  <script src="/socket.io.min.js"></script>

  <script>

    const socket = io(); // ÏƒÏÎ½Î´ÎµÏƒÎ· ÏƒÏ„Î¿ Flask server

    let athleteList = [];
    let athletesByCategory = {}; 
    const plateColors = {
      25: '#c0392b',      // ÎºÏŒÎºÎºÎ¹Î½Î¿ Î¼ÎµÎ³Î¬Î»Î¿
      20: '#2980b9',      // Î¼Ï€Î»Îµ
      15: '#f1c40f',      // ÎºÎ¯Ï„ÏÎ¹Î½Î¿
      10: '#27ae60',      // Ï€ÏÎ¬ÏƒÎ¹Î½Î¿
      5:  '#ecf0f1',      // Î»ÎµÏ…ÎºÏŒ (Î¼Î¹ÎºÏÏŒ)
      '2.5c': '#888888',  // Î³ÎºÏÎ¹ - Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î± (collar)
      2.5: '#c0392b',     // ÎºÏŒÎºÎºÎ¹Î½Î¿ Î¼Î¹ÎºÏÏŒ 2.5
      2: '#2980b9',       // Î¼Ï€Î»Îµ (Î­Î¾Ï‰ Î±Ï€ÏŒ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±)
      1.5: '#f1c40f',     // ÎºÎ¯Ï„ÏÎ¹Î½Î¿
      1: '#27ae60',       // Ï€ÏÎ¬ÏƒÎ¹Î½Î¿
      0.5: '#ecf0f1'      // Î»ÎµÏ…ÎºÏŒ
    };

    let currentCategory = "";
    let currentAthlete = "";
    let club = "";
    let currentExercise = "";
    let currentWeight = 0;
    let attemptsData = {}; 
    let countdownInterval = null;
    let remainingSeconds = 0;
    let isPaused = false;
    let bestLifts = {}; 
    let originalAthleteOrder = [];

    // --- Elements ---
    const fileInput = document.getElementById('fileInput');
    const athleteSelect = document.getElementById('athleteSelect');
    const exerciseSelect = document.getElementById('exerciseSelect');
    const weightInput = document.getElementById('weightInput');
    const athleteInfoDiv = document.getElementById('athleteInfo');
    const attemptInfo = document.getElementById('attemptInfo');
    const barbellEl = document.getElementById('barbell');
    const attemptCirclesEl = document.getElementById('attemptCircles');
    const timerEl = document.getElementById('timer');

    const btn1min = document.getElementById('btn1min');
    const btn2min = document.getElementById('btn2min');
    const btn5min = document.getElementById('btn5min');
    const btnPause = document.getElementById('btnPause');
    const btnReset = document.getElementById('btnReset');
    const btnValid = document.getElementById('btnValid');
    const btnInvalid = document.getElementById('btnInvalid');

  

  function broadcastState() {

    socket.emit("state_update", {
      category: currentCategory,
      athlete: currentAthlete,
      club: club,
      group: "women",
      exercise: currentExercise,
      weight: currentWeight,
      attemptsData: attemptsData,
      timer: remainingSeconds,
      timerRunning: countdownInterval !== null,
      bestLifts: bestLifts,
      timerPaused: isPaused
    });

  }

  // --- Î¦ÏŒÏÏ„Ï‰ÏƒÎ· JSON Î±ÏÏ‡ÎµÎ¯Î¿Ï… ---
  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if (!Array.isArray(data)) {
          alert('Î›Î¬Î¸Î¿Ï‚ Î¼Î¿ÏÏ†Î® JSON: Î ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Î»Î¯ÏƒÏ„Î± Î±Ï€ÏŒ Î±Î¸Î»Î®Ï„ÏÎ¹ÎµÏ‚');
          return;
        }
        athleteList = data;
        populateAthleteSelect();
        resetSelections();
        alert('Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!');
        console.log(data);
      } catch(err) {
        alert('Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ JSON: ' + err.message);
      }
    };
    reader.readAsText(file);
  });

  // --- Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚ ---

  function populateAthleteSelect() {
    athleteSelect.innerHTML = '<option value="">-- Î•Ï€Î¹Î»Î¿Î³Î® --</option>';
    originalAthleteOrder = [];

    athleteList.forEach((athlete, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = athlete.name;
      athleteSelect.appendChild(option);
      originalAthleteOrder.push(option.cloneNode(true)); 
    });
    athleteSelect.disabled = false;
  }

  function updateAthleteList() {
    athleteSelect.innerHTML = '<option value="">-- Î•Ï€Î¹Î»Î¿Î³Î® --</option>';
    if (athletesByCategory[currentCategory]) {
      for (const athlete of athletesByCategory[currentCategory]) {
        const option = document.createElement('option');
        option.value = athlete;
        option.textContent = athlete;
        athleteSelect.appendChild(option);
      }
      athleteSelect.disabled = false;
      weightInput.disabled = true;
    } else {
      athleteSelect.disabled = true;
      weightInput.disabled = true;
    }
    currentAthlete = "";
    currentExercise = "";
    currentWeight = 0;
    updateUI();
    broadcastState();
  }

  function resetSelections() {
    currentAthlete = "";
    currentExercise = "";
    currentWeight = 0;
    athleteSelect.value = "";
    athleteSelect.disabled = true; 
    exerciseSelect.value = "";
    exerciseSelect.disabled = false;
    weightInput.value = "";
    weightInput.disabled = true;
    athleteInfoDiv.innerHTML = "";
    resetTimer();
    updateUI();
    broadcastState();
  }

  function resetTimer() {
    clearInterval(countdownInterval);
    countdownInterval = null;
    remainingSeconds = 0;
    isPaused = false;
    timerEl.textContent = "00:00";
    timerEl.classList.remove('red');
    btnPause.disabled = true;
    broadcastState();
  }

  function updateDisplayTimer(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    timerEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    timerEl.classList.toggle('red', seconds <= 10 && seconds > 0);
  }

 function calculatePlates(weight) {
    
    let barWeight = 15;
    
    if (!weight || weight < barWeight) return { inside: [], outside: [], collar: true };

    let perSide = (weight - barWeight) / 2;

    const insidePlatesList = [25, 20, 15, 10, 5, 2.5];
    const outsidePlatesList = [2, 1.5, 1, 0.5];
    const inside = [];
    const outside = [];

    if (perSide >= 2.5) {
      perSide -= 2.5;
    } else {
      return { inside: [], outside: [], collar: false };
    }

    for (const plate of insidePlatesList) {
      while (perSide >= plate - 0.001) {
        inside.push(plate);
        perSide -= plate;
      }
    }

    for (const plate of outsidePlatesList) {
      while (perSide >= plate - 0.001) {
        outside.push(plate);
        perSide -= plate;
      }
    }

    return { inside, outside, collar: true };
  }

  function renderBarbell(weight) {
    barbellEl.innerHTML = "";
    if (!weight || weight < 20) return;

    const { inside, outside, collar } = calculatePlates(weight);

    function createPlate(w) {
      const div = document.createElement('div');
      div.className = 'plate';
      div.style.backgroundColor = plateColors[w] || '#888';
      div.style.height = `${30 + w * 2}px`;
      div.title = `${w} ÎºÎ¹Î»Î¬`;
      div.style.border = `2px solid #111`;
      div.style.margin = '0 4px';
      return div;
    }

    // ÎœÏ€Î¬ÏÎ± (shaft)
    const shaft = document.createElement('div');
    shaft.style.width = '50px';
    shaft.style.height = '20px';
    shaft.style.background = '#888';
    barbellEl.appendChild(shaft);

    // Î”ÎµÎ¾Î¹Î¬ Ï€Î»ÎµÏ…ÏÎ¬ Î¼ÏŒÎ½Î¿
    const rightSide = document.createElement('div');
    rightSide.style.display = 'flex';
    rightSide.style.alignItems = 'center';

    // ÎœÎµÎ³Î¬Î»ÎµÏ‚ Ï€Î»Î¬ÎºÎµÏ‚ (Î¼Î­ÏƒÎ± Î±Ï€ÏŒ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±)
    inside.forEach(p => rightSide.appendChild(createPlate(p)));

    // Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î± Î® Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹, 2.5 Î¼Î¹ÎºÏÏŒ
    if (collar) {
      const collarRight = document.createElement('div');
      collarRight.className = 'plate';
      collarRight.style.backgroundColor = plateColors['2.5c']; // Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±
      collarRight.style.height = '35px';
      collarRight.style.width = '15px';
      collarRight.style.margin = '0 6px';
      collarRight.style.border = '2px solid #111';
      collarRight.title = 'Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î± 2.5 kg';
      rightSide.appendChild(collarRight);
    }

    // ÎœÎ¹ÎºÏÎ­Ï‚ Ï€Î»Î¬ÎºÎµÏ‚ (Î­Î¾Ï‰ Î±Ï€ÏŒ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±)
    outside.forEach(p => rightSide.appendChild(createPlate(p)));

    barbellEl.appendChild(rightSide);
  }


  function updateAttemptInfo() {
    if (!currentAthlete || !currentExercise) {
      attemptInfo.textContent = "";
      return;
    }
    const key = `${currentAthlete}_${currentExercise}`;
    const attempts = attemptsData[key] || [];
    if (attempts.length >= 3) {
      attemptInfo.textContent = `ÎˆÎ³Î¹Î½Î±Î½ Î¿Î¹ 3 Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹ÎµÏ‚ Î³Î¹Î± Ï„Î¿Î½ ${currentAthlete} ÏƒÏ„Î¿ ${currentExercise}`;
    } else {
      attemptInfo.textContent = `Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± ${attempts.length + 1} Î±Ï€ÏŒ 3`;
    }
  }

  function renderAttemptCircles() {
  attemptCirclesEl.innerHTML = "";
  if (!currentAthlete || !currentExercise) return;
  const key = `${currentAthlete}_${currentExercise}`;
  const attempts = attemptsData[key] || [];
  for (let i = 0; i < 3; i++) {
    const circle = document.createElement('div');
    circle.className = 'circle';
    const attempt = attempts[i];
    if (attempt?.result === 'valid') {
      circle.classList.add('valid');
    } else if (attempt?.result === 'invalid') {
      circle.classList.add('invalid');
    }
    attemptCirclesEl.appendChild(circle);
  }
}


  function updateUI() {
    
    athleteSelect.disabled = false;
     exerciseSelect.disabled = !currentAthlete;
    weightInput.disabled = !currentAthlete;

    btn1min.disabled = !currentWeight;
    btn2min.disabled = !currentWeight;
    btn5min.disabled = !currentWeight;
    btnPause.disabled = !countdownInterval;
    btnReset.disabled = countdownInterval === null && remainingSeconds === 0;
    btnValid.disabled = countdownInterval === null || !currentAthlete || !currentExercise || attemptsData[`${currentAthlete}_${currentExercise}`]?.length >= 3;
    btnInvalid.disabled = btnValid.disabled;

    updateAttemptInfo();
    renderAttemptCircles();
    renderBarbell(currentWeight);
    updateAthleteListStyling();
  }

  function updateAthleteListStyling() {
    const completed = [];
    const remaining = [];
    const selectedValue = athleteSelect.value;

    originalAthleteOrder.forEach(option => {
      const index = option.value;
      const name = athleteList[index]?.name;
      const key = `${name}_${currentExercise}`;
      const attempts = attemptsData[key] || [];
      const newOption = option.cloneNode(true);

      if (attempts.length >= 3) {
        newOption.style.color = 'red';
        completed.push(newOption);
      } else {
        newOption.style.color = '';
        remaining.push(newOption);
      }

      // Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î¿ Ï„ÏÎ­Ï‡Ï‰Î½ Î±Î¸Î»Î·Ï„Î®Ï‚, Ï„Î¿Î½ ÎµÏ€Î¹Î»Î­Î³Ï‰
      if (index === selectedValue) {
        newOption.selected = true;
      }

    });

    athleteSelect.innerHTML = '<option value="">-- Î•Ï€Î¹Î»Î¿Î³Î® --</option>';
    [...remaining, ...completed].forEach(opt => athleteSelect.appendChild(opt));
  }


  athleteSelect.addEventListener('change', () => {
    const index = athleteSelect.value;
    if (index !== "") {
      currentAthlete = athleteList[index].name;
      club = athleteList[index].club;
      athleteInfoDiv.innerHTML =
          `<strong>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿:</strong> ${currentAthlete}<br><strong>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚:</strong> ${club}`;
    } else {
      currentAthlete = "";
      club = "";
      athleteInfoDiv.innerHTML = "";
    }

    weightInput.disabled = !currentAthlete;
    exerciseSelect.value = "";

    resetTimer();
    updateUI();
    broadcastState();
  });

  exerciseSelect.addEventListener('change', () => {
    if (!exerciseSelect.value) return;

    if (currentExercise && currentExercise !== exerciseSelect.value) {
      const allDone = athleteList.every(a => {
        const key = `${a.name}_${currentExercise}`;
        return (attemptsData[key]?.length || 0) >= 3;
      });
      if (!allDone) {
        alert("Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Î¿Î»Î¿ÎºÎ»Î·ÏÏ‰Î¸ÎµÎ¯ Î¿Î¹ Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹ÎµÏ‚ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Î±Î¸Î»Î·Ï„ÏÎ¹ÏÎ½ Î³Î¹Î± Ï„Î·Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· Î¬ÏƒÎºÎ·ÏƒÎ·.");
        exerciseSelect.value = currentExercise;
        return;
      }
    }

    currentExercise = exerciseSelect.value;

    // ÎœÏŒÎ»Î¹Ï‚ Î³Î¯Î½ÎµÎ¹ Î· Î±ÏÏ‡Î¹ÎºÎ® ÎµÏ€Î¹Î»Î¿Î³Î® Î¬ÏƒÎºÎ·ÏƒÎ·Ï‚, Ï„Î·Î½ ÎºÎ»ÎµÎ¹Î´ÏÎ½Ï‰
    exerciseSelect.disabled = true;
    athleteSelect.disabled = false;

    resetTimer();
    updateUI();
    broadcastState();
  });

  weightInput.addEventListener('input', () => {
    const val = parseFloat(weightInput.value);
    if (isNaN(val) || val < 20) {
      currentWeight = 0;
    } else {
      currentWeight = val;
    }
    updateUI();
    broadcastState();
  });

  function startTimer(seconds) {
    if (countdownInterval) clearInterval(countdownInterval);
    remainingSeconds = seconds;
    isPaused = false;
    updateDisplayTimer(remainingSeconds);
    countdownInterval = setInterval(() => {
      if (!isPaused) {
        remainingSeconds--;
        updateDisplayTimer(remainingSeconds);
        if (remainingSeconds <= 0) {
          clearInterval(countdownInterval);
          countdownInterval = null;
          btnPause.disabled = true;
          timerEl.classList.remove('red');
          broadcastState();
          alert('ÎŸ Ï‡ÏÏŒÎ½Î¿Ï‚ Ï„ÎµÎ»ÎµÎ¯Ï‰ÏƒÎµ!');
        }
        broadcastState();
      }
    }, 1000);
    btnPause.disabled = false;
    btnReset.disabled = false;
    updateUI();
  }

  btn1min.addEventListener('click', () => startTimer(60));
  btn2min.addEventListener('click', () => startTimer(120));
  btn5min.addEventListener('click', () => startTimer(300));

  btnPause.addEventListener('click', () => {
    if (!countdownInterval) return;
    isPaused = !isPaused;
    btnPause.textContent = isPaused ? "â–¶ï¸ Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±" : "â¸ï¸ Î Î¬Ï…ÏƒÎ·";
    broadcastState();
  });

  btnReset.addEventListener('click', () => {
    resetTimer();
    btnPause.textContent = "â¸ï¸ Î Î¬Ï…ÏƒÎ·";
  });

  btnValid.addEventListener('click', () => {
    if (!currentAthlete || !currentExercise) return;
    const key = `${currentAthlete}_${currentExercise}`;
    if (!attemptsData[key]) attemptsData[key] = [];
    if (attemptsData[key].length >= 3) {
      alert('ÎˆÏ‡Î¿Ï…Î½ Î³Î¯Î½ÎµÎ¹ Î®Î´Î· 3 Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹ÎµÏ‚!');
      return;
    }
    attemptsData[key].push({ weight: currentWeight, result: 'valid' });

   
    if (!bestLifts[currentAthlete]) bestLifts[currentAthlete] = {};
    bestLifts[currentAthlete][currentExercise] = currentWeight;

    resetTimer();
    updateUI();
    broadcastState();
  });

  btnInvalid.addEventListener('click', () => {
    if (!currentAthlete || !currentExercise) return;
    const key = `${currentAthlete}_${currentExercise}`;
    if (!attemptsData[key]) attemptsData[key] = [];
    if (attemptsData[key].length >= 3) {
      alert('ÎˆÏ‡Î¿Ï…Î½ Î³Î¯Î½ÎµÎ¹ Î®Î´Î· 3 Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹ÎµÏ‚!');
      return;
    }
    attemptsData[key].push({ weight: currentWeight, result: 'invalid' });
    resetTimer();
    updateUI();
    broadcastState();
  });

</script>

</body>
</html>